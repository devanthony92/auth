-- Set client messages to warning to reduce verbosity
SET client_min_messages = WARNING;

-- Table: password_reset_tokens
DROP TABLE IF EXISTS password_reset_tokens CASCADE;
CREATE TABLE IF NOT EXISTS password_reset_tokens (
	id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	user_id INTEGER NOT NULL,
	jti UUID NOT NULL,
	token_hash VARCHAR(64) NOT NULL,
	ip_address VARCHAR(45),
	user_agent JSONB NULL DEFAULT NULL,
	created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
	expires_at TIMESTAMPTZ NOT NULL,
	used_at TIMESTAMPTZ NULL DEFAULT NULL
);

CREATE INDEX idx_password_reset_tokens_user_id ON password_reset_tokens (user_id);
CREATE INDEX idx_password_reset_tokens_expires_at ON password_reset_tokens (expires_at);

-- Table: api
DROP TABLE IF EXISTS "api" CASCADE;
CREATE TABLE "api" (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  grupo VARCHAR(50),
  url_api VARCHAR(460) NOT NULL,
  id_aplicacion INTEGER NOT NULL,
  class_front VARCHAR(460),
  tipo_accion INTEGER DEFAULT 1,
  nombre VARCHAR(145) NOT NULL,
  descripcion VARCHAR(255),
  id_persona INTEGER,
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE INDEX idx_api_aplicacion ON "api"(id_aplicacion);
CREATE INDEX idx_api_grupo ON "api"(grupo);
CREATE INDEX idx_api_tipo_accion ON "api"(tipo_accion);
CREATE INDEX idx_api_activo ON "api"(activo);
CREATE INDEX idx_api_created_at ON "api"(created_at);
CREATE INDEX idx_api_aplicacion_activo ON "api"(id_aplicacion, activo);
CREATE INDEX idx_api_nombre ON "api"(nombre);

-- Table: aplicaciones
DROP TABLE IF EXISTS "aplicaciones" CASCADE;
CREATE TABLE "aplicaciones" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  key VARCHAR(50) NOT NULL,
  nombre VARCHAR(150) NOT NULL,
  descripcion VARCHAR(250),
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  CONSTRAINT aplicaciones_key_unique UNIQUE(key)
);

CREATE INDEX idx_aplicaciones_key ON "aplicaciones"(key);
CREATE INDEX idx_aplicaciones_activo ON "aplicaciones"(activo);
CREATE INDEX idx_aplicaciones_created_at ON "aplicaciones"(created_at);

-- Table: aplicaciones_cliente
DROP TABLE IF EXISTS "aplicaciones_cliente" CASCADE;
CREATE TABLE "aplicaciones_cliente" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  client_id VARCHAR(255) NOT NULL,
  client_secret VARCHAR(64) NOT NULL,
  nombre VARCHAR(100) NOT NULL,
  descripcion VARCHAR(255),
  redirect_uris TEXT,
  scopes VARCHAR(500),
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE UNIQUE INDEX ix_aplicaciones_cliente_client_id ON "aplicaciones_cliente"(client_id);
CREATE INDEX idx_aplicaciones_cliente_activo ON "aplicaciones_cliente"(activo);
CREATE INDEX idx_aplicaciones_cliente_created_at ON "aplicaciones_cliente"(created_at);

-- Table: bitacoras
DROP TABLE IF EXISTS "bitacoras" CASCADE;
CREATE TABLE "bitacoras" (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  id_tipo_bitacora INTEGER NOT NULL,
  datos_anteriores TEXT,
  datos_insertados TEXT,
  observacion VARCHAR(500),
  menu VARCHAR(245),
  url_api VARCHAR(460),
  id_persona INTEGER,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_bitacoras_tipo ON "bitacoras"(id_tipo_bitacora);
CREATE INDEX idx_bitacoras_persona ON "bitacoras"(id_persona);
CREATE INDEX idx_bitacoras_fecha ON "bitacoras"(created_at);
CREATE INDEX idx_bitacoras_menu ON "bitacoras"(menu);
CREATE INDEX idx_bitacoras_url_api ON "bitacoras"(url_api);

-- Table: cuentas_sociales
DROP TABLE IF EXISTS "cuentas_sociales" CASCADE;
CREATE TABLE "cuentas_sociales" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  proveedor VARCHAR(20) NOT NULL,
  id_usuario_proveedor VARCHAR(255) NOT NULL,
  token_proveedor TEXT,
  correo VARCHAR(100),
  nombre VARCHAR(100),
  id_persona INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE UNIQUE INDEX unique_proveedor_usuario ON "cuentas_sociales"(proveedor, id_usuario_proveedor);
CREATE INDEX idx_cuentas_sociales_usuario ON "cuentas_sociales"(id_persona);
CREATE INDEX idx_cuentas_sociales_proveedor ON "cuentas_sociales"(proveedor);
CREATE INDEX idx_cuentas_sociales_created_at ON "cuentas_sociales"(created_at);

-- Table: menu
DROP TABLE IF EXISTS "menu" CASCADE;
CREATE TABLE "menu" (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  url_menu VARCHAR(250) NOT NULL,
  id_aplicacion INTEGER NOT NULL,
  padre INTEGER,
  nombre VARCHAR(250) NOT NULL,
  ruta_front VARCHAR(250),
  orden INTEGER DEFAULT 0,
  visible INTEGER DEFAULT 1,
  acceso INTEGER DEFAULT 1,
  icono VARCHAR(300),
  target VARCHAR(49),
  activo INTEGER DEFAULT 1,
  descripcion VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP,
  id_persona INTEGER
);

CREATE UNIQUE INDEX url_menu_unique ON "menu"(url_menu);
CREATE INDEX idx_menu_aplicacion ON "menu"(id_aplicacion);
CREATE INDEX idx_menu_padre ON "menu"(padre);
CREATE INDEX idx_menu_orden ON "menu"(orden);
CREATE INDEX idx_menu_activo ON "menu"(activo);
CREATE INDEX idx_menu_visible ON "menu"(visible);
CREATE INDEX idx_menu_aplicacion_activo ON "menu"(id_aplicacion, activo);
CREATE INDEX idx_menu_nombre ON "menu"(nombre);

-- Table: permiso_api
DROP TABLE IF EXISTS "permiso_api" CASCADE;
CREATE TABLE "permiso_api" (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  rol_id INTEGER NOT NULL,
  api_id BIGINT NOT NULL,
  id_persona BIGINT,
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE UNIQUE INDEX unique_rol_api ON "permiso_api"(rol_id, api_id);
CREATE INDEX idx_permiso_api_rol ON "permiso_api"(rol_id);
CREATE INDEX idx_permiso_api_api ON "permiso_api"(api_id);
CREATE INDEX idx_permiso_api_activo ON "permiso_api"(activo);
CREATE INDEX idx_permiso_api_created_at ON "permiso_api"(created_at);
CREATE INDEX idx_permiso_api_rol_activo ON "permiso_api"(rol_id, activo);

-- Table: permiso_menu
DROP TABLE IF EXISTS "permiso_menu" CASCADE;
CREATE TABLE "permiso_menu" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  rol_id INTEGER NOT NULL,
  menu_id BIGINT NOT NULL,
  id_persona INTEGER,
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE UNIQUE INDEX unique_rol_menu ON "permiso_menu"(rol_id, menu_id);
CREATE INDEX idx_permiso_menu_rol ON "permiso_menu"(rol_id);
CREATE INDEX idx_permiso_menu_menu ON "permiso_menu"(menu_id);
CREATE INDEX idx_permiso_menu_activo ON "permiso_menu"(activo);
CREATE INDEX idx_permiso_menu_created_at ON "permiso_menu"(created_at);
CREATE INDEX idx_permiso_menu_rol_activo ON "permiso_menu"(rol_id, activo);


-- Table: recordings
DROP TABLE IF EXISTS "recordings" CASCADE;
CREATE TABLE "recordings" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  file_path VARCHAR(500) NOT NULL,
  container_name VARCHAR(255) NOT NULL,
  file_name VARCHAR(255) NOT NULL,
  file_size INTEGER,
  etiqueta VARCHAR(255),
  id_persona INTEGER,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_recordings_file_name ON "recordings"(file_name);

-- Table: roles
DROP TABLE IF EXISTS "roles" CASCADE;
CREATE TABLE "roles" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  nombre VARCHAR(50) NOT NULL,
  id_aplicacion INTEGER NOT NULL,
  descripcion VARCHAR(255),
  key_publico VARCHAR(50),
  id_persona INTEGER,
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE UNIQUE INDEX unique_rol_aplicacion ON "roles"(nombre, id_aplicacion);
CREATE UNIQUE INDEX key_publico_unique ON "roles"(key_publico);
CREATE INDEX idx_roles_aplicacion ON "roles"(id_aplicacion);
CREATE INDEX idx_roles_activo ON "roles"(activo);
CREATE INDEX idx_roles_key_publico ON "roles"(key_publico);
CREATE INDEX idx_roles_created_at ON "roles"(created_at);

-- Table: tipo_bitacora
DROP TABLE IF EXISTS "tipo_bitacora" CASCADE;
CREATE TABLE "tipo_bitacora" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  nombre VARCHAR(145) NOT NULL,
  descripcion VARCHAR(255),
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tipo_bitacora_nombre ON "tipo_bitacora"(nombre);
CREATE INDEX idx_tipo_bitacora_activo ON "tipo_bitacora"(activo);
CREATE INDEX idx_tipo_bitacora_created_at ON "tipo_bitacora"(created_at);

-- Table: usuarios
DROP TABLE IF EXISTS "usuarios" CASCADE;
CREATE TABLE "usuarios" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  username VARCHAR(50) NOT NULL,
  email VARCHAR(100) NOT NULL,
  hash_clave VARCHAR(64) NOT NULL,
  nombres VARCHAR(50),
  apellidos VARCHAR(50),
  firma VARCHAR(250),
  foto VARCHAR(250),
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE UNIQUE INDEX username_unique ON "usuarios"(username);
CREATE UNIQUE INDEX email_unique ON "usuarios"(email);
CREATE INDEX idx_usuarios_email ON "usuarios"(email);
CREATE INDEX idx_usuarios_username ON "usuarios"(username);
CREATE INDEX idx_usuarios_activo ON "usuarios"(activo);
CREATE INDEX idx_usuarios_created_at ON "usuarios"(created_at);
CREATE INDEX idx_usuarios_nombres_apellidos ON "usuarios"(nombres, apellidos);

-- Table: usuario_roles
DROP TABLE IF EXISTS "usuario_roles" CASCADE;
CREATE TABLE "usuario_roles" (
  id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  id_usuario INTEGER NOT NULL,
  id_rol INTEGER NOT NULL,
  id_persona INTEGER,
  activo INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE UNIQUE INDEX unique_usuario_rol ON "usuario_roles"(id_usuario, id_rol);
CREATE INDEX idx_usuario_roles_usuario ON "usuario_roles"(id_usuario);
CREATE INDEX idx_usuario_roles_rol ON "usuario_roles"(id_rol);
CREATE INDEX idx_usuario_roles_activo ON "usuario_roles"(activo);
CREATE INDEX idx_usuario_roles_created_at ON "usuario_roles"(created_at);
CREATE INDEX idx_usuario_roles_usuario_activo ON "usuario_roles"(id_usuario, activo);


-- Table: access_tokens
DROP TABLE IF EXISTS "access_tokens" CASCADE;
CREATE TABLE access_tokens (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id INTEGER NOT NULL,
    jti UUID NOT NULL,
    is_revoked BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    expires_at TIMESTAMPTZ NOT NULL,
    revoked_at TIMESTAMPTZ
);

-- Indices
CREATE INDEX ix_access_tokens_user_id ON access_tokens (user_id);
CREATE INDEX ix_access_tokens_user_active ON access_tokens (user_id, expires_at);
CREATE INDEX ix_access_tokens_exp ON access_tokens (expires_at);


-- Table: refresh_tokens
DROP TABLE IF EXISTS "refresh_tokens" CASCADE;
CREATE TABLE "refresh_tokens" (
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id INTEGER NOT NULL,
    token_jti UUID NOT NULL UNIQUE,
    token_hash VARCHAR(64) NOT NULL UNIQUE,
    ip VARCHAR(45),
    user_agent JSONB,
    device_id VARCHAR(64) NOT NULL,
    is_revoked BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMPTZ NOT NULL,
    revoked_at TIMESTAMPTZ
);

-- Índices
CREATE INDEX ix_refresh_tokens_user_id ON refresh_tokens (user_id);
CREATE INDEX ix_refresh_tokens_user_active ON refresh_tokens (user_id, is_revoked);
CREATE INDEX ix_refresh_tokens_exp ON refresh_tokens (expires_at);


-- Table: login_logs
CREATE TABLE login_logs (
    id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id INTEGER NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    ip VARCHAR(45) NOT NULL,
    location VARCHAR(255),
    user_agent JSONB,

    CONSTRAINT fk_login_logs_user
      FOREIGN KEY (user_id)
      REFERENCES usuarios(id)
      ON DELETE CASCADE
);

-- Índices
CREATE INDEX ix_login_logs_user_id ON login_logs (user_id);
CREATE INDEX ix_login_logs_timestamp ON login_logs (timestamp);


-- ============================
-- Foreign Key Constraints (add after tables exist)
-- ============================

ALTER TABLE "api" ADD CONSTRAINT fk_api_aplicaciones FOREIGN KEY (id_aplicacion) REFERENCES "aplicaciones"(id) ON DELETE CASCADE;
ALTER TABLE "api" ADD CONSTRAINT fk_api_persona FOREIGN KEY (id_persona) REFERENCES "usuarios"(id) ON DELETE SET NULL;
ALTER TABLE "bitacoras" ADD CONSTRAINT fk_bitacoras_tipo FOREIGN KEY (id_tipo_bitacora) REFERENCES "tipo_bitacora"(id) ON DELETE CASCADE;
ALTER TABLE "bitacoras" ADD CONSTRAINT fk_bitacoras_persona FOREIGN KEY (id_persona) REFERENCES "usuarios"(id) ON DELETE SET NULL;
ALTER TABLE "cuentas_sociales" ADD CONSTRAINT fk_cuentas_sociales_persona FOREIGN KEY (id_persona) REFERENCES "usuarios"(id) ON DELETE CASCADE;
ALTER TABLE "menu" ADD CONSTRAINT fk_menu_aplicacion FOREIGN KEY (id_aplicacion) REFERENCES "aplicaciones"(id) ON DELETE CASCADE;
ALTER TABLE "permiso_api" ADD CONSTRAINT fk_permiso_api_rol FOREIGN KEY (rol_id) REFERENCES "roles"(id) ON DELETE CASCADE;
ALTER TABLE "permiso_api" ADD CONSTRAINT fk_permiso_api_api FOREIGN KEY (api_id) REFERENCES "api"(id) ON DELETE CASCADE;
ALTER TABLE "permiso_menu" ADD CONSTRAINT fk_permiso_menu_rol FOREIGN KEY (rol_id) REFERENCES "roles"(id) ON DELETE CASCADE;
ALTER TABLE "permiso_menu" ADD CONSTRAINT fk_permiso_menu_menu FOREIGN KEY (menu_id) REFERENCES "menu"(id) ON DELETE CASCADE;
ALTER TABLE "recordings" ADD CONSTRAINT fk_recording_persona FOREIGN KEY (id_persona) REFERENCES "usuarios"(id) ON DELETE SET NULL;
ALTER TABLE "roles" ADD CONSTRAINT fk_roles_aplicacion FOREIGN KEY (id_aplicacion) REFERENCES "aplicaciones"(id) ON DELETE CASCADE;
ALTER TABLE "usuario_roles" ADD CONSTRAINT fk_usuario_roles_usuario FOREIGN KEY (id_usuario) REFERENCES "usuarios"(id) ON DELETE CASCADE;
ALTER TABLE "usuario_roles" ADD CONSTRAINT fk_usuario_roles_rol FOREIGN KEY (id_rol) REFERENCES "roles"(id) ON DELETE CASCADE;
ALTER TABLE "usuario_roles" ADD CONSTRAINT fk_usuario_roles_persona FOREIGN KEY (id_persona) REFERENCES "usuarios"(id) ON DELETE CASCADE;
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT uq_password_reset_tokens_jti UNIQUE (jti);
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT fk_password_reset_tokens_persona FOREIGN KEY (user_id) REFERENCES "usuarios" (id) ON UPDATE NO ACTION ON DELETE CASCADE;
ALTER TABLE "refresh_tokens" ADD CONSTRAINT fk_refresh_tokens_user FOREIGN KEY (user_id) REFERENCES usuarios(id) ON DELETE CASCADE;
ALTER TABLE "access_tokens" ADD CONSTRAINT uq_access_tokens_jti UNIQUE (jti);
ALTER TABLE "access_tokens" ADD CONSTRAINT fk_access_tokens_user FOREIGN KEY (user_id) REFERENCES usuarios(id) ON DELETE CASCADE;
-- ============================
-- INSERTS converted to PostgreSQL syntax (booleans and timestamps)
-- ============================

-- aplicaciones data
INSERT INTO "aplicaciones" (id, key, nombre, descripcion, activo, created_at, updated_at, deleted_at) VALUES
  (1, 'AUTH_SYSTEM', 'Sistema de Autenticación', 'Sistema principal de autenticación y autorización', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL);

-- api data
INSERT INTO "api" (id, grupo, url_api, id_aplicacion, class_front, tipo_accion, nombre, descripcion, id_persona, activo, created_at, updated_at, deleted_at) VALUES
  (1, 'auth', '/api/v1/auth/login', 1, 'AuthService.login', 1, 'Login', 'Iniciar sesión', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (2, 'auth', '/api/v1/auth/logout', 1, 'AuthService.logout', 1, 'Logout', 'Cerrar sesión', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (3, 'auth', '/api/v1/auth/me', 1, 'AuthService.me', 2, 'Datos Usuario', 'Obtener datos del usuario actual', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (4, 'usuarios', '/api/v1/usuarios', 1, 'UsuarioService.getAll', 2, 'Listar Usuarios', 'Obtener lista de usuarios', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (5, 'usuarios', '/api/v1/usuarios', 1, 'UsuarioService.create', 3, 'Crear Usuario', 'Crear nuevo usuario', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (6, 'usuarios', '/api/v1/usuarios/{id}', 1, 'UsuarioService.update', 4, 'Actualizar Usuario', 'Actualizar usuario existente', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (7, 'usuarios', '/api/v1/usuarios/{id}', 1, 'UsuarioService.delete', 5, 'Eliminar Usuario', 'Eliminar usuario', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (8, 'roles', '/api/v1/roles', 1, 'RolService.getAll', 2, 'Listar Roles', 'Obtener lista de roles', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (9, 'roles', '/api/v1/roles', 1, 'RolService.create', 3, 'Crear Rol', 'Crear nuevo rol', NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL);


-- permiso: none for aplicaciones_cliente (no data)

-- bitacoras: no data to insert here in original

-- menu data
INSERT INTO "menu" (id, url_menu, id_aplicacion, padre, nombre, ruta_front, orden, visible, acceso, icono, target, activo, descripcion, created_at, updated_at, deleted_at, id_persona) VALUES
  (1, '/dashboard', 1, NULL, 'Dashboard', '/dashboard', 1, 1, 1, 'dashboard', NULL, 1, 'Panel principal del sistema', '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL, NULL),
  (2, '/usuarios', 1, NULL, 'Gestión de Usuarios', '/usuarios', 2, 1, 1, 'users', NULL, 1, 'Administración de usuarios', '2025-06-10 12:23:34', '2025-07-25 02:35:56', NULL, NULL),
  (3, '/usuarios/lista', 1, 2, 'Lista de Usuarios', '/usuarios/lista', 1, 1, 1, 'list', NULL, 1, 'Ver lista de usuarios', '2025-06-10 12:23:34', '2025-07-25 02:35:59', NULL, NULL),
  (4, '/usuarios/crear', 1, 2, 'Crear Usuario', '/usuarios/crear', 2, 1, 1, 'user-plus', NULL, 1, 'Crear nuevo usuario', '2025-06-10 12:23:34', '2025-07-25 02:36:00', NULL, NULL),
  (5, '/roles', 1, NULL, 'Gestión de Roles', '/roles', 3, 1, 1, 'shield', NULL, 1, 'Administración de roles', '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL, NULL),
  (6, '/configuracion', 1, NULL, 'Configuración', '/configuracion', 4, 1, 1, 'settings', NULL, 1, 'Configuración del sistema', '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL, NULL);

-- roles data
INSERT INTO "roles" (id, nombre, id_aplicacion, descripcion, key_publico, id_persona, activo, created_at, updated_at, deleted_at) VALUES
  (1, 'SUPER_ADMIN', 1, 'Super Administrador del sistema', 'Desarrollador', NULL, 1, '2025-06-10 12:23:34', '2025-07-25 12:53:56', NULL),
  (2, 'ADMIN', 1, 'Administrador del sistema', 'Administrador', NULL, 1, '2025-06-10 12:23:34', '2025-07-25 12:53:55', NULL),
  (3, 'USER', 1, 'Usuario básico del sistema', 'Usuario', NULL, 1, '2025-06-10 12:23:34', '2025-07-25 12:53:54', NULL),
  (4, 'GUEST', 1, 'Usuario invitado', 'Visitante', NULL, 1, '2025-06-10 12:23:34', '2025-07-25 12:53:52', NULL);

-- permiso_api data
INSERT INTO "permiso_api" (id, rol_id, api_id, id_persona, activo, created_at, updated_at, deleted_at) VALUES
  (1, 1, 1, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (2, 1, 2, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (3, 1, 3, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (4, 1, 4, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (5, 1, 5, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (6, 1, 6, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (7, 1, 7, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (8, 1, 8, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (9, 1, 9, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (16, 2, 1, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (17, 2, 2, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (18, 2, 3, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (19, 2, 4, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (20, 2, 5, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (21, 2, 6, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (22, 2, 8, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (23, 3, 1, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (24, 3, 2, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (25, 3, 3, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL);

-- permiso_menu data
INSERT INTO "permiso_menu" (id, rol_id, menu_id, id_persona, activo, created_at, updated_at, deleted_at) VALUES
  (8, 2, 1, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (9, 2, 2, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (10, 1, 3, NULL, 1, '2025-06-10 12:23:34', '2025-07-25 02:26:54', NULL),
  (11, 1, 4, NULL, 1, '2025-06-10 12:23:34', '2025-07-25 02:27:00', NULL),
  (12, 2, 5, NULL, 1, '2025-06-10 12:23:34', '2025-07-25 02:53:18', NULL),
  (13, 3, 1, NULL, 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34', NULL),
  (22, 1, 1, NULL, 1, '2025-07-25 02:18:09', '2025-07-25 02:18:09', NULL),
  (23, 1, 2, NULL, 1, '2025-07-25 02:18:09', '2025-07-25 02:18:09', NULL);


-- tipo_bitacora data
INSERT INTO "tipo_bitacora" (id, nombre, descripcion, activo, created_at, updated_at) VALUES
  (1, 'LOGIN', 'Inicio de sesión de usuario', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34'),
  (2, 'LOGOUT', 'Cierre de sesión de usuario', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34'),
  (3, 'CREATE', 'Creación de registro', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34'),
  (4, 'UPDATE', 'Actualización de registro', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34'),
  (5, 'DELETE', 'Eliminación de registro', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34'),
  (6, 'ERROR', 'Error del sistema', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34'),
  (7, 'ACCESS_DENIED', 'Acceso denegado', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34'),
  (8, 'PASSWORD_CHANGE', 'Cambio de contraseña', 1, '2025-06-10 12:23:34', '2025-06-10 12:23:34');

-- usuarios data
INSERT INTO "usuarios" (id, username, email, hash_clave, nombres, apellidos, firma, foto, activo, created_at, updated_at, deleted_at) VALUES
  (1, 'superadmin', 'superadmin@sistema.com', '$2b$12$HvvUyQiVlXmNTS5ntxgfXOBD2.oi9ThcepFESu3rsm9TYOClEDwt.', 'Super', 'Administrador', 'firma\\logo-cos_9c51bbda.png', 'foto\\logo-cos_6fd5b309.png', 1, '2025-06-10 12:25:34', '2025-08-24 00:10:02', NULL),
  (2, 'admin', 'admin@sistema.com', '$2b$12$Cl/qAWIR62ndAVxcdbXzcOTM4PSnLmHKQzTEcsVzsDdKJQYThdynu', 'Administrador', 'Sistema', NULL, NULL, 1, '2025-06-10 12:25:34', '2025-07-24 23:47:08', NULL),
  (3, 'string', 'user@example.com', '$2b$12$lrNW9ovULmI7vkR64mg7We3i9AFiqotKTMGChcEyO.hD/ifKwXE/2', 'string', 'string', 'string', 'string', 1, '2025-07-24 23:46:07', '2025-07-24 23:59:12', NULL);

-- usuario_roles data
INSERT INTO "usuario_roles" (id, id_usuario, id_rol, id_persona, activo, created_at, updated_at, deleted_at) VALUES
  (1, 1, 1, 1, 1, '2025-06-10 12:25:34', NULL, NULL),
  (2, 2, 2, 2, 1, '2025-06-10 12:25:34', NULL, NULL),
  (3, 1, 4, 1, 1, '2025-07-25 01:04:41', '2025-07-25 12:01:59', NULL),
  (4, 3, 2, 1, 1, '2025-07-25 01:04:41', NULL, NULL),
  (5, 3, 3, 1, 1, '2025-07-25 01:04:41', NULL, NULL);
-- If you need to reset sequences to follow the maximum inserted id:
-- (recommended to run after performing the explicit inserts above)
DO $$
DECLARE
  tbl record;
BEGIN
  FOR tbl IN
    SELECT table_name, column_name
    FROM information_schema.columns
    WHERE column_name = 'id'
      AND table_schema = 'public'
      AND table_name IN (
        'api','aplicaciones','aplicaciones_cliente','bitacoras','cuentas_sociales',
        'menu','permiso_api','permiso_menu','recording','recordings','roles',
        'tipo_bitacora','usuarios','usuario_roles'
      )
  LOOP
    EXECUTE format('SELECT setval(
          pg_get_serial_sequence(%L, %L),
          GREATEST(coalesce(max(%I), 0) + 1, 1),
          false
      ) FROM %I', tbl.table_name, tbl.column_name, tbl.column_name, tbl.table_name);
  END LOOP;
END$$;
